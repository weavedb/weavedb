import { getThreadRng } from "./random.js"
import * as Scalar from "./scalar.js"

export default class WasmField2 {
  constructor(tm, prefix, F) {
    this.tm = tm
    this.prefix = prefix

    this.F = F
    this.type = "F2"
    this.m = F.m * 2
    this.n8 = this.F.n8 * 2
    this.n32 = this.F.n32 * 2
    this.n64 = this.F.n64 * 2

    this.pOp1 = tm.alloc(F.n8 * 2)
    this.pOp2 = tm.alloc(F.n8 * 2)
    this.pOp3 = tm.alloc(F.n8 * 2)
    this.tm.instance.exports[prefix + "_zero"](this.pOp1)
    this.zero = tm.getBuff(this.pOp1, this.n8)
    this.tm.instance.exports[prefix + "_one"](this.pOp1)
    this.one = tm.getBuff(this.pOp1, this.n8)

    this.negone = this.neg(this.one)
    this.two = this.add(this.one, this.one)
  }

  op2(opName, a, b) {
    this.tm.setBuff(this.pOp1, a)
    this.tm.setBuff(this.pOp2, b)
    this.tm.instance.exports[this.prefix + opName](
      this.pOp1,
      this.pOp2,
      this.pOp3
    )
    return this.tm.getBuff(this.pOp3, this.n8)
  }

  op2Bool(opName, a, b) {
    this.tm.setBuff(this.pOp1, a)
    this.tm.setBuff(this.pOp2, b)
    return !!this.tm.instance.exports[this.prefix + opName](
      this.pOp1,
      this.pOp2
    )
  }

  op1(opName, a) {
    this.tm.setBuff(this.pOp1, a)
    this.tm.instance.exports[this.prefix + opName](this.pOp1, this.pOp3)
    return this.tm.getBuff(this.pOp3, this.n8)
  }

  op1Bool(opName, a) {
    this.tm.setBuff(this.pOp1, a)
    return !!this.tm.instance.exports[this.prefix + opName](
      this.pOp1,
      this.pOp3
    )
  }

  add(a, b) {
    return this.op2("_add", a, b)
  }

  eq(a, b) {
    return this.op2Bool("_eq", a, b)
  }

  isZero(a) {
    return this.op1Bool("_isZero", a)
  }

  sub(a, b) {
    return this.op2("_sub", a, b)
  }

  neg(a) {
    return this.op1("_neg", a)
  }

  inv(a) {
    return this.op1("_inverse", a)
  }

  isNegative(a) {
    return this.op1Bool("_isNegative", a)
  }

  toMontgomery(a) {
    return this.op1("_toMontgomery", a)
  }

  fromMontgomery(a) {
    return this.op1("_fromMontgomery", a)
  }

  mul(a, b) {
    return this.op2("_mul", a, b)
  }

  mul1(a, b) {
    return this.op2("_mul1", a, b)
  }

  div(a, b) {
    this.tm.setBuff(this.pOp1, a)
    this.tm.setBuff(this.pOp2, b)
    this.tm.instance.exports[this.prefix + "_inverse"](this.pOp2, this.pOp2)
    this.tm.instance.exports[this.prefix + "_mul"](
      this.pOp1,
      this.pOp2,
      this.pOp3
    )
    return this.tm.getBuff(this.pOp3, this.n8)
  }

  square(a) {
    return this.op1("_square", a)
  }

  isSquare(a) {
    return this.op1Bool("_isSquare", a)
  }

  sqrt(a) {
    return this.op1("_sqrt", a)
  }

  exp(a, b) {
    if (!(b instanceof Uint8Array)) {
      b = Scalar.toLEBuff(Scalar.e(b))
    }
    this.tm.setBuff(this.pOp1, a)
    this.tm.setBuff(this.pOp2, b)
    this.tm.instance.exports[this.prefix + "_exp"](
      this.pOp1,
      this.pOp2,
      b.byteLength,
      this.pOp3
    )
    return this.tm.getBuff(this.pOp3, this.n8)
  }

  e(a, b) {
    if (a instanceof Uint8Array) return a
    if (Array.isArray(a) && a.length == 2) {
      const c1 = this.F.e(a[0], b)
      const c2 = this.F.e(a[1], b)
      const res = new Uint8Array(this.F.n8 * 2)
      res.set(c1)
      res.set(c2, this.F.n8 * 2)
      return res
    } else {
      throw new Error("invalid F2")
    }
  }

  toString(a, radix) {
    const s1 = this.F.toString(a.slice(0, this.F.n8), radix)
    const s2 = this.F.toString(a.slice(this.F.n8), radix)
    return `[${s1}, ${s2}]`
  }

  fromRng(rng) {
    const c1 = this.F.fromRng(rng)
    const c2 = this.F.fromRng(rng)
    const res = new Uint8Array(this.F.n8 * 2)
    res.set(c1)
    res.set(c2, this.F.n8)
    return res
  }

  random() {
    return this.fromRng(getThreadRng())
  }

  toObject(a) {
    const c1 = this.F.toObject(a.slice(0, this.F.n8))
    const c2 = this.F.toObject(a.slice(this.F.n8, this.F.n8 * 2))
    return [c1, c2]
  }

  fromObject(a) {
    const buff = new Uint8Array(this.F.n8 * 2)
    const b1 = this.F.fromObject(a[0])
    const b2 = this.F.fromObject(a[1])
    buff.set(b1)
    buff.set(b2, this.F.n8)
    return buff
  }

  c1(a) {
    return a.slice(0, this.F.n8)
  }

  c2(a) {
    return a.slice(this.F.n8)
  }
}
